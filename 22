console.log("script.js ì •ìƒ ë¡œë“œ"); 
// ì½˜ì†”ì— script.jsê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŒì„ ì¶œë ¥ (ë””ë²„ê¹…ìš©)

function goHome() {
  // goHome í•¨ìˆ˜: ì‚¬ìš©ìê°€ í˜¸ì¶œ ì‹œ í™ˆí˜ì´ì§€(recommend.html)ë¡œ ì´ë™í•˜ëŠ” ê¸°ëŠ¥
  window.location.href = "recommend.html"; 
  // location.href ì†ì„±ì„ í†µí•´ ë¸Œë¼ìš°ì € í˜ì´ì§€ë¥¼ ì§€ì •í•œ URLë¡œ ì´ë™ì‹œí‚´
}

document.addEventListener("DOMContentLoaded", async () => {
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ë¬¸ì„œì˜ DOMì´ ì™„ì „íˆ ë¡œë“œë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë¨ (DOMContentLoadedëŠ” HTMLë§Œ íŒŒì‹±ë˜ì—ˆì„ ë•Œ íŠ¸ë¦¬ê±°ë¨)
  console.log("DOMContentLoaded ì‹¤í–‰ë¨"); // ì½˜ì†”ì— DOMContentLoadedê°€ ì‹¤í–‰ë˜ì—ˆìŒì„ ì¶œë ¥

  const storedUser = localStorage.getItem("user"); 
  // localStorageì—ì„œ keyê°€ 'user'ì¸ í•­ëª©ì„ ê°€ì ¸ì˜´ (ë¬¸ìì—´ í˜•íƒœ)
  if (storedUser) {
    const user = JSON.parse(storedUser); 
    // JSON ë¬¸ìì—´ì„ JavaScript ê°ì²´ë¡œ ë³€í™˜ (ì—­ì§ë ¬í™”)
    showUserInfo(user); // ì‚¬ìš©ì ì •ë³´ë¥¼ í˜ì´ì§€ì— ë°˜ì˜í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
  }

  if (document.getElementById("dramaList")) {
    // ìš”ì†Œ idê°€ dramaListì¸ HTML ìš”ì†Œê°€ ì¡´ì¬í•  ê²½ìš°
    await loadDramas(); // ë“œë¼ë§ˆ ëª©ë¡ì„ ë¹„ë™ê¸°ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ ì‹¤í–‰
  }

  if (window.location.pathname.includes("detail.html")) {
    // í˜„ì¬ í˜ì´ì§€ì˜ ê²½ë¡œëª…ì´ detail.htmlì„ í¬í•¨í•  ê²½ìš° (ìƒì„¸ í˜ì´ì§€)
    await loadDetail(); // ë“œë¼ë§ˆ ìƒì„¸ ì •ë³´ ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ
  }

  if (window.location.pathname.includes("edit.html")) {
    // í˜„ì¬ í˜ì´ì§€ê°€ edit.htmlì¸ ê²½ìš° (ìˆ˜ì • í˜ì´ì§€)
    const params = new URLSearchParams(window.location.search); 
    // URLì˜ ì¿¼ë¦¬ ë¬¸ìì—´ì„ íŒŒì‹±í•˜ê¸° ìœ„í•œ ê°ì²´ ìƒì„±
    const id = params.get("id"); // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ id ê°’ì„ ê°€ì ¸ì˜´ (ì˜ˆ: ?id=3 â†’ 3)
    if (!id) {
      alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); // idê°€ ì—†ëŠ” ê²½ìš° ê²½ê³  í‘œì‹œ
      window.location.href = "recommend.html"; // í™ˆìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
      return;
    }

    try {
      const response = await fetch(`http://127.0.0.1:5000/get-drama/${id}`); 
      // ë“œë¼ë§ˆ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” fetch ìš”ì²­ (GET)
      const drama = await response.json(); // ì„œë²„ ì‘ë‹µì„ JSON ê°ì²´ë¡œ ë³€í™˜

      document.getElementById("editTitle").value = drama.title; 
      // ì…ë ¥ í•„ë“œì— ë“œë¼ë§ˆ ì œëª© ì„¤ì •
      document.getElementById("editContent").value = drama.content; 
      // ì…ë ¥ í•„ë“œì— ë“œë¼ë§ˆ ë‚´ìš© ì„¤ì •

      if (drama.filename) {
        const fileLabel = document.createElement("p"); // <p> ìš”ì†Œ ìƒì„±
        fileLabel.textContent = `ê¸°ì¡´ íŒŒì¼: ${drama.filename}`; // í…ìŠ¤íŠ¸ ì„¤ì •
        document.getElementById("editForm").prepend(fileLabel); 
        // í¼ ìƒë‹¨ì— í•´ë‹¹ <p> ìš”ì†Œ ì‚½ì…
      }

      const secretCheckbox = document.getElementById("editIsSecret"); 
      // ë¹„ë°€ê¸€ ì—¬ë¶€ ì²´í¬ë°•ìŠ¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const passwordInput = document.getElementById("editSecretPassword"); 
      // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

      secretCheckbox.checked = drama.is_secret; 
      // ë“œë¼ë§ˆê°€ ë¹„ë°€ê¸€ì´ë©´ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬ ìƒíƒœë¡œ ì„¤ì •
      passwordInput.style.display = drama.is_secret ? "block" : "none"; 
      // ë¹„ë°€ê¸€ì´ë©´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í‘œì‹œ
      passwordInput.value = drama.password || ""; 
      // ë¹„ë°€ë²ˆí˜¸ ê°’ì„ ì„¤ì • (ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´)

      secretCheckbox.addEventListener("change", () => {
        passwordInput.style.display = secretCheckbox.checked ? "block" : "none"; 
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ì‹œ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
      });

      const form = document.getElementById("editForm"); // ìˆ˜ì • í¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘ ë§‰ê¸° (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€)
        const formData = new FormData(form); 
        // í¼ ë°ì´í„°ë¥¼ FormData ê°ì²´ë¡œ ìƒì„± (íŒŒì¼ í¬í•¨ ê°€ëŠ¥)
        try {
          const res = await fetch(`http://127.0.0.1:5000/edit-drama/${id}`, {
            method: "POST", // POST ë°©ì‹ìœ¼ë¡œ ì„œë²„ì— ë°ì´í„° ì „ì†¡
            body: formData // ìš”ì²­ ë³¸ë¬¸ì— FormData í¬í•¨
          });
          const result = await res.json(); // ì‘ë‹µì„ JSON ê°ì²´ë¡œ íŒŒì‹±
          if (res.ok) {
            alert("ìˆ˜ì • ì™„ë£Œ!"); // ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
            window.location.href = `detail.html?id=${id}`; 
            // ìˆ˜ì •ëœ ë“œë¼ë§ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
          } else {
            alert("ìˆ˜ì • ì‹¤íŒ¨: " + result.error); // ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶œë ¥
          }
        } catch (err) {
          console.error("ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨:", err); // ì˜¤ë¥˜ ë¡œê·¸ ì¶œë ¥
          alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì‚¬ìš©ì ì•Œë¦¼
        }
      });
    } catch (err) {
      console.error("ë“œë¼ë§ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err); // ì½˜ì†” ì˜¤ë¥˜ ì¶œë ¥
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); // ì‚¬ìš©ì ì•Œë¦¼ì°½
    }
  }

  if (window.location.pathname.includes("create.html")) {
    // create.html í˜ì´ì§€ì¼ ê²½ìš° (ë“œë¼ë§ˆ ì‘ì„± í˜ì´ì§€)
    const createForm = document.getElementById("createForm"); 
    // ì‘ì„± í¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

    const storedUser = localStorage.getItem("user"); 
    // ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    if (!storedUser) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤."); // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ì„ ê²½ìš° ê²½ê³ 
      window.location.href = "recommend.html"; // í™ˆìœ¼ë¡œ ì´ë™
      return;
    }
    const user = JSON.parse(storedUser); // JSON íŒŒì‹±í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ê°ì²´í™”
    document.getElementById("hiddenUserId").value = user.id; 
    // ìˆ¨ê²¨ì§„ í•„ë“œì— ì‚¬ìš©ì ID ì„¤ì •

    const secretCheckbox = document.getElementById("isSecret"); // ë¹„ë°€ê¸€ ì—¬ë¶€ ì²´í¬ë°•ìŠ¤
    const passwordInput = document.getElementById("secretPassword"); 
    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ
    passwordInput.style.display = "none"; // ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ìˆ¨ê¹€
    secretCheckbox.addEventListener("change", () => {
      passwordInput.style.display = secretCheckbox.checked ? "block" : "none"; 
      // ì²´í¬ ìƒíƒœì— ë”°ë¼ í•„ë“œ í‘œì‹œ ì—¬ë¶€ ë³€ê²½
    });

    createForm.addEventListener("submit", async (e) => {
      e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

      const formData = new FormData(createForm); // í¼ ë°ì´í„°ë¥¼ FormDataë¡œ êµ¬ì„±
      const title = formData.get("title")?.trim(); // ì œëª© í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° ë° ê³µë°± ì œê±°
      const content = formData.get("content")?.trim(); 
      // ë‚´ìš© í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° ë° ê³µë°± ì œê±°
      const isSecret = formData.get("is_secret") === "on"; // ì²´í¬ë°•ìŠ¤ ê°’ ì—¬ë¶€ í™•ì¸
      const password = formData.get("password"); // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°

      if (!title || !content) {
        alert("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!"); // í•„ìˆ˜ í•­ëª© ëˆ„ë½ ì‹œ ê²½ê³ 
        return;
      }

      if (isSecret && !password) {
        alert("ë¹„ë°€ê¸€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); // ë¹„ë°€ê¸€ì¸ë° ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ ì‹œ ê²½ê³ 
        return;
      }

      try {
        const response = await fetch("http://127.0.0.1:5000/add-drama", {
          method: "POST", // POST ë°©ì‹ìœ¼ë¡œ ì„œë²„ì— ìƒˆ ë“œë¼ë§ˆ ì¶”ê°€ ìš”ì²­
          body: formData // ë³¸ë¬¸ì— FormData í¬í•¨ (íŒŒì¼ í¬í•¨ ê°€ëŠ¥)
        });

        const result = await response.json(); // JSON ì‘ë‹µ íŒŒì‹±
        if (response.ok) {
          alert("ë“œë¼ë§ˆê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"); // ì„±ê³µ ë©”ì‹œì§€
          window.location.href = `detail.html?id=${result.id}`; 
          // ì¶”ê°€ëœ ë“œë¼ë§ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        } else {
          alert("ë“±ë¡ ì‹¤íŒ¨: " + result.error); // ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶œë ¥
        }
      } catch (err) {
        console.error("ë“±ë¡ ìš”ì²­ ì‹¤íŒ¨:", err); // ì½˜ì†” ì˜¤ë¥˜ ì¶œë ¥
        alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì‚¬ìš©ì ì•Œë¦¼
      }
    });
  }

  const title = document.querySelector("h1"); // í˜ì´ì§€ì˜ <h1> ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  if (title) {
    title.addEventListener("click", () => {
      goHome(); // í´ë¦­ ì‹œ í™ˆìœ¼ë¡œ ì´ë™í•˜ëŠ” goHome í•¨ìˆ˜ í˜¸ì¶œ
    });
  }

  const signupForm = document.getElementById("signupForm"); // íšŒì›ê°€ì… í¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  if (signupForm) {
    const profileInput = document.getElementById("signupProfileImage"); 
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ input ìš”ì†Œ
    const previewImage = document.getElementById("previewImage"); 
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° <img> ìš”ì†Œ

    if (profileInput) {
      profileInput.addEventListener("change", (e) => {
        const file = e.target.files[0]; // ì‚¬ìš©ìê°€ ì„ íƒí•œ íŒŒì¼ ì¤‘ ì²« ë²ˆì§¸ íŒŒì¼
        if (file) {
          const reader = new FileReader(); // FileReader ê°ì²´ ìƒì„±
          reader.onload = (ev) => {
            previewImage.src = ev.target.result; // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
            previewImage.style.display = "block"; // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
          };
          reader.readAsDataURL(file); // íŒŒì¼ì„ ë°ì´í„° URLë¡œ ì½ì–´ì˜´ (ì´ë¯¸ì§€ ì¸ì½”ë”©)
        } else {
          previewImage.src = ""; // ì´ë¯¸ì§€ ì´ˆê¸°í™”
          previewImage.style.display = "none"; // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€
        }
      });
    }

    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
      const formData = new FormData(signupForm); // íšŒì›ê°€ì… í¼ ë°ì´í„° êµ¬ì„±
      try {
        const response = await fetch("http://127.0.0.1:5000/signup", {
          method: "POST", // POST ë°©ì‹ ìš”ì²­
          body: formData // íŒŒì¼ í¬í•¨ íšŒì›ê°€ì… ì •ë³´ ì „ì†¡
        });
        const result = await response.json(); // ì‘ë‹µ JSON íŒŒì‹±
        if (response.ok) {
          alert("íšŒì›ê°€ì… ì„±ê³µ!"); // ì„±ê³µ ì•Œë¦¼
          window.location.href = "recommend.html"; // í™ˆìœ¼ë¡œ ì´ë™
        } else {
          alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + result.error); // ì‹¤íŒ¨ ì•Œë¦¼
        }
      } catch (error) {
        console.error("íšŒì›ê°€ì… ìš”ì²­ ì‹¤íŒ¨:", error); // ì˜¤ë¥˜ ë¡œê·¸
        alert("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì˜¤ë¥˜ ì•Œë¦¼
      }
    });
  }
});
// ===================== ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • í˜ì´ì§€ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ =====================
async function loadUserEditData(userId) {
  // userId: ìˆ˜ì •í•˜ë ¤ëŠ” ì‚¬ìš©ìì˜ ê³ ìœ  ID
  try {
    const response = await fetch(`http://127.0.0.1:5000/user/${userId}`); 
    // ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ API ìš”ì²­
    if (!response.ok) throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); 
    // ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ ë°œìƒ
    const user = await response.json(); // JSON í˜•íƒœë¡œ ì‘ë‹µ íŒŒì‹±

    document.getElementById("editName").value = user.name || ""; 
    // ì´ë¦„ ì…ë ¥ í•„ë“œì— ì‚¬ìš©ì ì´ë¦„ ì„¤ì • (ì—†ìœ¼ë©´ ê³µë°±)
    document.getElementById("editSchool").value = user.school || ""; 
    // í•™êµ ì…ë ¥ í•„ë“œì— ì‚¬ìš©ì í•™êµ ì„¤ì •

    const previewImg = document.getElementById("editPreviewImage"); 
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    if (user.profile_image) {
      previewImg.src = `http://127.0.0.1:5000/uploads/${user.profile_image}`; 
      // ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
      previewImg.style.display = "block"; // ì´ë¯¸ì§€ í‘œì‹œ
    } else {
      previewImg.style.display = "none"; // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ìˆ¨ê¹€
    }
  } catch (error) {
    console.error("ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error); // ì½˜ì†”ì— ì˜¤ë¥˜ ë¡œê·¸ ì¶œë ¥
    alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
    window.location.href = "recommend.html"; // í™ˆìœ¼ë¡œ ì´ë™
  }
}


// ===================== ë“œë¼ë§ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ =====================
async function loadDramas() {
  // ë“œë¼ë§ˆ ì „ì²´ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ í˜ì´ì§€ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
  console.log("ë“œë¼ë§ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰"); // í•¨ìˆ˜ ì‹¤í–‰ ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
  try {
    const response = await fetch("http://127.0.0.1:5000/get-dramas"); 
    // ì „ì²´ ë“œë¼ë§ˆ ëª©ë¡ ìš”ì²­ (GET)
    const dramas = await response.json(); // JSON ë°°ì—´ë¡œ ì‘ë‹µ íŒŒì‹±

    const list = document.getElementById("dramaList"); // ë“œë¼ë§ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•  ul ìš”ì†Œ
    const emptyMessage = document.getElementById("emptyMessage"); 
    // ë“œë¼ë§ˆê°€ ì—†ì„ ê²½ìš° í‘œì‹œí•  ë©”ì‹œì§€ ìš”ì†Œ

    list.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™” (í´ë¦¬ì–´)
    if (dramas.length === 0) {
      emptyMessage.style.display = "block"; // ë“œë¼ë§ˆê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
    } else {
      emptyMessage.style.display = "none"; // ë“œë¼ë§ˆê°€ ìˆìœ¼ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€
      dramas.forEach((drama) => {
        const li = document.createElement("li"); // ìƒˆë¡œìš´ ë¦¬ìŠ¤íŠ¸ í•­ëª© ìƒì„±
        li.innerHTML = `<strong>${drama.title}${drama.is_secret ? " ğŸ”" : ""}</strong>`; // ë“œë¼ë§ˆ ì œëª© + ë¹„ë°€ê¸€ ì—¬ë¶€ í‘œì‹œ
        li.style.cursor = "pointer"; // ì»¤ì„œ í¬ì¸í„°ë¡œ ë³€ê²½ (í´ë¦­ ê°€ëŠ¥ UI)
        li.addEventListener("click", () => {
          window.location.href = `detail.html?id=${drama.id}`; 
          // í´ë¦­ ì‹œ í•´ë‹¹ ë“œë¼ë§ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        });
        list.appendChild(li); // ë¦¬ìŠ¤íŠ¸ì— í•­ëª© ì¶”ê°€
      });
    }
  } catch (error) {
    console.error("ë“œë¼ë§ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì½˜ì†”ì— ì¶œë ¥
  }
}


// ===================== ë“œë¼ë§ˆ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ =====================
async function loadDetail() {
  // í˜„ì¬ URLì˜ id íŒŒë¼ë¯¸í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë“œë¼ë§ˆ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜´
  const params = new URLSearchParams(window.location.search); 
  // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ íŒŒë¼ë¯¸í„° ê°ì²´ ìƒì„±
  const id = params.get("id"); // ë“œë¼ë§ˆ ID ê°’ ì¶”ì¶œ
  let drama;

  try {
    const response = await fetch(`http://127.0.0.1:5000/get-drama/${id}`); 
    // IDì— í•´ë‹¹í•˜ëŠ” ë“œë¼ë§ˆ ë°ì´í„° ìš”ì²­
    if (!response.ok) throw new Error("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"); // ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ ë°œìƒ
    drama = await response.json(); // JSON í˜•íƒœë¡œ ì‘ë‹µ íŒŒì‹±

    if (drama.is_secret) {
      // ë¹„ë°€ê¸€ì¼ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
      const inputPw = prompt("ì´ ê¸€ì€ ë¹„ë°€ê¸€ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      const verifyResponse = await fetch("http://127.0.0.1:5000/verify-password", {
        method: "POST", // POST ë°©ì‹ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ìš”ì²­
        headers: {
          "Content-Type": "application/json" // ìš”ì²­ ë³¸ë¬¸ íƒ€ì… ì„¤ì •
        },
        body: JSON.stringify({ id, password: inputPw }) 
        // ìš”ì²­ ë³¸ë¬¸ìœ¼ë¡œ IDì™€ ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ì „ì†¡
      });

      if (!verifyResponse.ok) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); // ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ ë˜ëŠ” ì ‘ê·¼ ë¶ˆê°€
        window.location.href = "recommend.html"; // í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        return;
      }
    }

    document.getElementById("dramaTitle").value = drama.title; 
    // ì œëª© ì…ë ¥ë€ì— ë“œë¼ë§ˆ ì œëª© í‘œì‹œ
    document.getElementById("dramaContent").value = drama.content; 
    // ë‚´ìš© ì…ë ¥ë€ì— ë“œë¼ë§ˆ ë‚´ìš© í‘œì‹œ

    if (drama.user_id) {
      // ì‘ì„±ì ì •ë³´ê°€ ìˆëŠ” ê²½ìš° ì‘ì„±ì ì´ë¦„ í‘œì‹œ ë° í”„ë¡œí•„ ì—°ê²°
      try {
        const userResponse = await fetch(`http://127.0.0.1:5000/user/${drama.user_id}`); 
        // ì‘ì„±ì ì •ë³´ ìš”ì²­
        if (userResponse.ok) {
          const user = await userResponse.json(); // ì‘ì„±ì ì •ë³´ íŒŒì‹±
          const authorSpan = document.getElementById("dramaAuthor"); 
          // ì‘ì„±ì í‘œì‹œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
          authorSpan.textContent = user.name || "ì•Œ ìˆ˜ ì—†ìŒ"; // ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
          authorSpan.style.fontWeight = "bold"; // êµµê²Œ í‘œì‹œ
          authorSpan.style.cursor = "pointer"; // í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½

          authorSpan.addEventListener("click", () => {
            window.location.href = `user_profile_readonly.html?id=${user.id}`; 
            // í´ë¦­ ì‹œ í•´ë‹¹ ì‚¬ìš©ì í”„ë¡œí•„ë¡œ ì´ë™
          });

          const storedUser = localStorage.getItem("user"); 
          // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const currentUser = storedUser ? JSON.parse(storedUser) : null;
          const buttonGroup = document.querySelector(".button-group"); 
          // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ê·¸ë£¹

          if (!currentUser || currentUser.id !== user.id) {
            if (buttonGroup) buttonGroup.style.display = "none"; 
            // ì‘ì„±ìê°€ ì•„ë‹ ê²½ìš° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          }
        }
      } catch (err) {
        console.error("ì‘ì„±ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err); 
        // ì‘ì„±ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì½˜ì†” ì¶œë ¥
      }
    }

    if (drama.filename) {
      const downloadLink = document.getElementById("fileDownload"); 
      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ìš”ì†Œ
      downloadLink.href = `http://127.0.0.1:5000/uploads/${drama.filename}`; 
      // ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ì„¤ì •
      downloadLink.setAttribute("download", drama.filename); 
      // ë‹¤ìš´ë¡œë“œ ì†ì„± ì„¤ì • (ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ìœ ë„)

      const originalName = drama.filename.substring(drama.filename.indexOf('_') + 1); 
      // íŒŒì¼ ì´ë¦„ì—ì„œ ì ‘ë‘ì‚¬ ì œê±°
      downloadLink.textContent = originalName; // íŒŒì¼ëª… í‘œì‹œ í…ìŠ¤íŠ¸ ì„¤ì •

      downloadLink.style.display = "inline-block"; // ë§í¬ í‘œì‹œ
    }
  } catch (error) {
    document.getElementById("dramaTitle").value = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë“œë¼ë§ˆ"; 
    // ì˜¤ë¥˜ ì‹œ ì œëª© ì˜ì—­ì— ë©”ì‹œì§€ í‘œì‹œ
    document.getElementById("dramaContent").value = "í•´ë‹¹ ë“œë¼ë§ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."; 
    // ì˜¤ë¥˜ ì‹œ ë‚´ìš© ì˜ì—­ì— ë©”ì‹œì§€ í‘œì‹œ
    console.error("ë“œë¼ë§ˆ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error); // ì˜¤ë¥˜ ì½˜ì†” ì¶œë ¥
  }
}
// ===================== ë“œë¼ë§ˆ ìˆ˜ì • í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ =====================
function editDrama() {
  const params = new URLSearchParams(window.location.search); 
  // í˜„ì¬ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°ì²´ ìƒì„±
  const id = params.get("id"); // id íŒŒë¼ë¯¸í„° ê°’ ì¶”ì¶œ
  window.location.href = `edit.html?id=${id}`; 
  // í•´ë‹¹ idë¥¼ ì¿¼ë¦¬ë¡œ ì „ë‹¬í•˜ë©° ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
}


// ===================== ë“œë¼ë§ˆ ìˆ˜ì • ë‚´ìš© ì €ì¥ í•¨ìˆ˜ =====================
async function saveEdit() {
  const params = new URLSearchParams(window.location.search); // URL íŒŒë¼ë¯¸í„°ì—ì„œ id ì¶”ì¶œ
  const id = params.get("id");
  const newTitle = document.getElementById("editTitle").value.trim(); 
  // ìˆ˜ì •ëœ ì œëª© ê°’ ê°€ì ¸ì˜¤ê¸°
  const newContent = document.getElementById("editContent").value.trim(); 
  // ìˆ˜ì •ëœ ë‚´ìš© ê°’ ê°€ì ¸ì˜¤ê¸°

  if (!newTitle || !newContent) {
    alert("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); // í•„ìˆ˜ê°’ ë¯¸ì…ë ¥ ì‹œ ì•Œë¦¼
    return;
  }

  try {
    const response = await fetch(`http://127.0.0.1:5000/edit-drama/${id}`, {
      method: "PUT", // PUT ë°©ì‹ìœ¼ë¡œ ìˆ˜ì • ìš”ì²­
      headers: { "Content-Type": "application/json" }, // ìš”ì²­ í—¤ë” ì„¤ì •
      body: JSON.stringify({ title: newTitle, content: newContent }) 
      // ìˆ˜ì •ëœ ë°ì´í„° ì „ì†¡
    });

    if (response.ok) {
      alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      window.location.href = `detail.html?id=${id}`; // ìˆ˜ì •ëœ ë“œë¼ë§ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    } else {
      alert("ìˆ˜ì • ì‹¤íŒ¨");
    }
  } catch (error) {
    console.error("ìˆ˜ì • ì˜¤ë¥˜:", error);
    alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
}


// ===================== ë“œë¼ë§ˆ ì‚­ì œ í•¨ìˆ˜ =====================
async function deleteDrama() {
  const params = new URLSearchParams(window.location.search); // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  const id = params.get("id");

  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; // ì‚¬ìš©ìì—ê²Œ ì‚­ì œ ì—¬ë¶€ ì¬í™•ì¸

  try {
    const response = await fetch(`http://127.0.0.1:5000/delete-drama/${id}`, {
      method: "DELETE", // DELETE ìš”ì²­ìœ¼ë¡œ ë“œë¼ë§ˆ ì‚­ì œ
      headers: { "Content-Type": "application/json" }
    });

    if (response.ok) {
      alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      window.location.href = "recommend.html"; // ì‚­ì œ í›„ í™ˆìœ¼ë¡œ ì´ë™
    } else {
      const errorMsg = await response.json();
      alert(`ì‚­ì œ ì‹¤íŒ¨: ${errorMsg.error}`); // ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
    }
  } catch (error) {
    console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
}
// ===================== ë“œë¼ë§ˆ ê²€ìƒ‰ í•¨ìˆ˜ =====================
async function searchDrama() {
  const query = document.getElementById("searchInput").value.toLowerCase(); 
  // ì…ë ¥ëœ ê²€ìƒ‰ì–´ë¥¼ ì†Œë¬¸ìë¡œ ë³€í™˜
  const searchType = document.getElementById("searchType").value; 
  // ê²€ìƒ‰ ê¸°ì¤€ (ì œëª©, ë‚´ìš©, ì „ì²´ ë“±)

  try {
    const response = await fetch("http://127.0.0.1:5000/get-dramas"); 
    // ì „ì²´ ë“œë¼ë§ˆ ëª©ë¡ ìš”ì²­
    const dramas = await response.json(); // JSONìœ¼ë¡œ íŒŒì‹±

    const filtered = dramas.filter((drama) => {
      if (searchType === "all") {
        // ì œëª© ë˜ëŠ” ë‚´ìš©ì— ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        return drama.title.toLowerCase().includes(query) ||
               drama.content.toLowerCase().includes(query);
      } else {
        // ì„ íƒëœ í•­ëª©ë§Œ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰
        return drama[searchType].toLowerCase().includes(query);
      }
    });

    const list = document.getElementById("dramaList"); // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¶œë ¥í•  ìš”ì†Œ
    list.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

    filtered.forEach((drama) => {
      const li = document.createElement("li"); // li ìš”ì†Œ ìƒì„±
      li.innerHTML = `<strong>${drama.title}${drama.is_secret ? " ğŸ”" : ""}</strong>`; 
      // ì œëª© í‘œì‹œ (ë¹„ë°€ê¸€ì´ë©´ ìë¬¼ì‡  ì•„ì´ì½˜)
      li.style.cursor = "pointer"; // ë§ˆìš°ìŠ¤ í¬ì¸í„° ì„¤ì •
      li.addEventListener("click", () => {
        window.location.href = `detail.html?id=${drama.id}`; // í´ë¦­ ì‹œ ìƒì„¸í˜ì´ì§€ ì´ë™
      });
      list.appendChild(li); // ëª©ë¡ì— ì¶”ê°€
    });
  } catch (error) {
    console.error("ê²€ìƒ‰ ì‹¤íŒ¨:", error); // ì˜¤ë¥˜ ë¡œê·¸
  }
}


// ===================== ë¡œê·¸ì¸ í•¨ìˆ˜ =====================
async function portalLogin() {
  const id = document.getElementById("loginId").value.trim(); // ì•„ì´ë”” ì…ë ¥ê°’
  const pw = document.getElementById("loginPw").value.trim(); // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ê°’

  if (!id || !pw) {
    alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); // ì…ë ¥ ëˆ„ë½ ì‹œ ì•Œë¦¼
    return;
  }

  try {
    const response = await fetch("http://127.0.0.1:5000/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, password: pw }) // JSONìœ¼ë¡œ ë¡œê·¸ì¸ ì •ë³´ ì „ì†¡
    });
    const result = await response.json(); // ì‘ë‹µ íŒŒì‹±

    if (response.ok) {
      alert("ë¡œê·¸ì¸ ì„±ê³µ!");
      const user = result.user; // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´
      localStorage.setItem("user", JSON.stringify(user)); 
      // ì‚¬ìš©ì ì •ë³´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
      showUserInfo(user); // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
    } else {
      alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.error}`);
    }
  } catch (error) {
    console.error("ë¡œê·¸ì¸ ìš”ì²­ ì‹¤íŒ¨:", error);
    alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


// ===================== ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ í•¨ìˆ˜ =====================
function showUserInfo(user) {
  const sideLoginBox = document.getElementById("sideLoginBox"); // ë¡œê·¸ì¸ UI ë°•ìŠ¤
  const userInfoBox = document.getElementById("userInfoBox"); 
  // ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ì •ë³´ ë°•ìŠ¤
  const userName = document.getElementById("userName"); // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ ìš”ì†Œ
  const profilePic = document.getElementById("profilePic"); // í”„ë¡œí•„ ì´ë¯¸ì§€ ìš”ì†Œ

  if (!sideLoginBox || !userInfoBox || !userName || !profilePic) {
    console.warn("ë¡œê·¸ì¸ UI ìš”ì†Œê°€ ì—†ì–´ì„œ showUserInfo ì‹¤í–‰ ì¤‘ë‹¨ë¨");
    return;
  }

  sideLoginBox.style.display = "none"; // ë¡œê·¸ì¸ ë°•ìŠ¤ ìˆ¨ê¹€
  userInfoBox.style.display = "block"; // ì‚¬ìš©ì ì •ë³´ ë°•ìŠ¤ í‘œì‹œ
  userName.textContent = user.name || user.username; // ì´ë¦„ ë˜ëŠ” ID í‘œì‹œ

  if (user.profile_image) {
    profilePic.src = `http://127.0.0.1:5000/uploads/${user.profile_image}`; 
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
  } else {
    profilePic.src = "";
    profilePic.style.backgroundColor = "#eee"; // ê¸°ë³¸ ë°°ê²½ ì„¤ì •
  }
}


// ===================== ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ =====================
function logout() {
  localStorage.removeItem("user"); // ì‚¬ìš©ì ì •ë³´ ì œê±°
  window.location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
}


// ===================== í”„ë¡œí•„ í˜ì´ì§€ ì´ë™ í•¨ìˆ˜ =====================
function goProfile() {
  window.location.href = "user_profile.html"; // í”„ë¡œí•„ í˜ì´ì§€ë¡œ ì´ë™
}


// ===================== íšŒì› íƒˆí‡´ í•¨ìˆ˜ =====================
async function deleteAccount() {
  const storedUser = localStorage.getItem("user"); // ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  if (!storedUser) {
    alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const user = JSON.parse(storedUser); // JSON â†’ ê°ì²´ ë³€í™˜

  if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

  try {
    const response = await fetch(`http://127.0.0.1:5000/delete-user/${user.id}`, {
      method: "DELETE" // ì‚¬ìš©ì ì‚­ì œ ìš”ì²­
    });
    const result = await response.json();

    if (response.ok) {
      alert("íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      localStorage.removeItem("user");
      window.location.href = "recommend.html";
    } else {
      alert("íƒˆí‡´ ì‹¤íŒ¨: " + result.error);
    }
  } catch (err) {
    console.error("íšŒì›íƒˆí‡´ ìš”ì²­ ì‹¤íŒ¨:", err);
    alert("íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}